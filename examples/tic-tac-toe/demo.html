<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Arcforge â€” Tic-Tac-Toe</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #0f0f0f; color: #e0e0e0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
  h1 { font-size: 1.4rem; margin-bottom: .6rem; color: #c0c0c0; letter-spacing: .05em; }
  #connect-bar { display: flex; gap: .5rem; margin-bottom: 1rem; align-items: center; }
  #connect-bar input { width: 4rem; padding: .3rem .5rem; border: 1px solid #444; border-radius: 4px; background: #1a1a1a; color: #e0e0e0; font-size: .9rem; text-align: center; }
  #connect-bar button { padding: .35rem .9rem; border: 1px solid #555; border-radius: 4px; background: #252525; color: #e0e0e0; cursor: pointer; font-size: .9rem; }
  #connect-bar button:hover { background: #333; }
  #status { font-size: .85rem; margin-bottom: .8rem; color: #888; min-height: 1.2em; }
  #board { display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(3, 100px); gap: 4px; margin-bottom: 1rem; }
  .cell { width: 100px; height: 100px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 2.4rem; font-weight: 700; cursor: pointer; transition: background .15s; user-select: none; }
  .cell:hover { background: #252525; }
  .cell.disabled { cursor: default; opacity: .6; }
  .cell.X { color: #5b9bd5; }
  .cell.O { color: #e06c75; }
  .cell.win { background: #1e3a1e; }
  #info { font-size: .95rem; min-height: 1.4em; }
  .muted { color: #666; }
</style>
</head>
<body>
<h1>âš™ Arcforge Tic-Tac-Toe</h1>
<div id="connect-bar">
  <label>Token <input id="token" placeholder="1"></label>
  <button id="btn" onclick="connect()">Connect</button>
</div>
<div id="status" class="muted">Disconnected</div>
<div id="board"></div>
<div id="info"></div>

<script>
const $ = s => document.getElementById(s);
const enc = new TextEncoder();
const dec = new TextDecoder();

let ws, seq = 0, myId = null, myMark = null, board, turn, players, gameOver = false, hbTimer;

// --- UI ---
function renderBoard() {
  const el = $('board');
  el.innerHTML = '';
  for (let r = 0; r < 3; r++) {
    for (let c = 0; c < 3; c++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      const v = board[r][c];
      if (v === 'X' || v === 'O') {
        cell.textContent = v;
        cell.classList.add(v);
      }
      if (gameOver || !myMark || v !== 'Empty' || players[turn] !== myId) {
        cell.classList.add('disabled');
      } else {
        cell.onclick = () => sendMove(r, c);
      }
      el.appendChild(cell);
    }
  }
}

function status(msg) { $('status').textContent = msg; }
function info(msg) { $('info').textContent = msg; }

// --- Protocol helpers ---
function envelope(payload) {
  return { seq: seq++, timestamp: 0, channel: 'ReliableOrdered', payload };
}

function send(obj) {
  ws.send(enc.encode(JSON.stringify(obj)));
}

function gameBytes(obj) {
  return Array.from(enc.encode(JSON.stringify(obj)));
}

function fromBytes(arr) {
  return JSON.parse(dec.decode(new Uint8Array(arr)));
}

// --- Connection lifecycle ---
function connect() {
  const token = $('token').value.trim() || '1';
  if (ws) { ws.onclose = null; ws.close(); }
  status('Connectingâ€¦');
  $('btn').disabled = true;

  ws = new WebSocket('ws://localhost:8080');
  ws.binaryType = 'arraybuffer';

  ws.onopen = () => {
    status('Handshakingâ€¦');
    send(envelope({ type: 'System', data: { type: 'Handshake', version: 1, token } }));
  };

  ws.onmessage = e => {
    const env = JSON.parse(dec.decode(new Uint8Array(e.data)));
    handleEnvelope(env);
  };

  ws.onclose = () => {
    status('Disconnected');
    $('btn').disabled = false;
    clearInterval(hbTimer);
  };

  ws.onerror = () => status('Connection error');
}

function handleEnvelope(env) {
  const p = env.payload;
  if (p.type === 'System') handleSystem(p.data);
  else if (p.type === 'Game') handleGame(fromBytes(p.data));
}

function handleSystem(msg) {
  switch (msg.type) {
    case 'HandshakeAck':
      myId = msg.player_id;
      status('Joining roomâ€¦');
      send(envelope({ type: 'System', data: { type: 'JoinOrCreate', name: 'ttt', options: [] } }));
      // Start heartbeat
      hbTimer = setInterval(() => {
        send(envelope({ type: 'System', data: { type: 'Heartbeat', client_time: Date.now() } }));
      }, 10000);
      break;
    case 'RoomJoined':
      status('Waiting for opponentâ€¦');
      break;
    case 'RoomState':
      applyState(fromBytes(msg.data));
      break;
    case 'Error':
      status(`Error ${msg.code}: ${msg.message}`);
      break;
    case 'HeartbeatAck':
      break;
  }
}

function handleGame(event) {
  if (event.MoveMade) {
    const m = event.MoveMade;
    board[m.row][m.col] = m.mark;
    turn = board.flat().filter(c => c !== 'Empty').length % 2;
    renderBoard();
    updateTurnInfo();
  }
  if (event.GameOver) {
    gameOver = true;
    const g = event.GameOver;
    info(g.winner ? (g.winner === myId ? 'ðŸŽ‰ You win!' : 'ðŸ˜ž You lose.') : 'ðŸ¤ Draw!');
    renderBoard();
  }
}

function applyState(state) {
  board = state.board;
  players = state.players;
  turn = state.turn;
  gameOver = state.winner !== null;
  myMark = players[0] === myId ? 'X' : 'O';
  status(`Connected â€” you are ${myMark}`);
  renderBoard();
  updateTurnInfo();
}

function updateTurnInfo() {
  if (gameOver) return;
  info(players[turn] === myId ? 'Your turn' : "Opponent's turn");
}

function sendMove(row, col) {
  send(envelope({ type: 'Game', data: gameBytes({ row, col }) }));
}

// Init empty board
board = Array.from({ length: 3 }, () => Array(3).fill('Empty'));
renderBoard();
</script>
</body>
</html>
